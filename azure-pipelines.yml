# azure-pipelines.yml
trigger: none

variables:
  # Terraform vars
  location:       centralus
  resource_group: vmss-test-rg
  vnet_name:      vmss-test-vnet
  subnet_name:    vmss-test-subnet
  vmss_name:      vmss-test-vmss
  vm_size:        Standard_B2ms
  image_sku:      22_04-lts
  identity_type:  SystemAssigned

  # name of your ARM service connection configured to use Managed Identity
  service_connection: 'DevOpsMI-ServiceConnection'

stages:

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- stage: TerraformPlan
  displayName: "ğŸ“ Terraform Plan"
  jobs:
  - job: Plan
    displayName: "Terraform Plan"
    pool:
      vmImage: ubuntu-latest

    steps:
    # 1) Azure CLI login via Managed Identity service connection
    - task: AzureCLI@2
      displayName: "Azure CLI: login (Managed Identity)"
      inputs:
        azureSubscription: $(service_connection)
        scriptType: bash
        addSpnToEnvironment: true
        useGlobalConfig: true
        scriptLocation: inlineScript
        inlineScript: |
          # tell Terraform backend & provider to use MSI
          export ARM_USE_MSI=true
          # capture subscription & tenant for Terraform
          export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
          export ARM_TENANT_ID=$(az account show --query tenantId -o tsv)
          echo "Using MSI â€“ sub=$ARM_SUBSCRIPTION_ID tenant=$ARM_TENANT_ID"

    # 2) terraform init (backend configured in your .tf files to use use_msi)
    - script: |
        terraform init \
          -backend-config="storage_account_name=yourtfstateacct" \
          -backend-config="container_name=tfstate" \
          -backend-config="key=vmss.tfstate"
      displayName: "terraform init"

    # 3) terraform plan
    - script: |
        terraform plan \
          -var="location=$(location)" \
          -var="resource_group=$(resource_group)" \
          -var="vnet_name=$(vnet_name)" \
          -var="subnet_name=$(subnet_name)" \
          -var="vmss_name=$(vmss_name)" \
          -var="vm_size=$(vm_size)" \
          -var="image_sku=$(image_sku)" \
          -var="identity_type=$(identity_type)"
      displayName: "terraform plan"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- stage: TerraformApply
  displayName: "ğŸš€ Terraform Apply"
  dependsOn: TerraformPlan
  jobs:
  - job: Apply
    displayName: "Terraform Apply"
    pool:
      vmImage: ubuntu-latest

    steps:
    # login again to refresh MSI token
    - task: AzureCLI@2
      displayName: "Azure CLI: login (Managed Identity)"
      inputs:
        azureSubscription: $(service_connection)
        scriptType: bash
        addSpnToEnvironment: true
        useGlobalConfig: true
        scriptLocation: inlineScript
        inlineScript: |
          export ARM_USE_MSI=true
          export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
          export ARM_TENANT_ID=$(az account show --query tenantId -o tsv)

    # apply
    - script: |
        terraform apply -auto-approve \
          -var="location=$(location)" \
          -var="resource_group=$(resource_group)" \
          -var="vnet_name=$(vnet_name)" \
          -var="subnet_name=$(subnet_name)" \
          -var="vmss_name=$(vmss_name)" \
          -var="vm_size=$(vm_size)" \
          -var="image_sku=$(image_sku)" \
          -var="identity_type=$(identity_type)"
      displayName: "terraform apply"
 
