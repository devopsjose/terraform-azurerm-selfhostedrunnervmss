trigger: none

variables:
  # Terraform inputs
  location:       centralus
  resource_group: tfstate-rg
  vnet_name:      vmss-test-vnet
  subnet_name:    vmss-test-subnet
  vmss_name:      vmss-test-vmss
  vm_size:        Standard_B2ms
  image_sku:      22_04-lts
  identity_type:  SystemAssigned

  service_connection: DevOpsMI-ServiceConnection

stages:

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Plan Stage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- stage: TerraformPlan
  displayName: "ğŸ“ Terraform Plan"
  jobs:
  - job: Plan
    displayName: "Init & Plan"
    pool:
      vmImage: ubuntu-latest
    steps:

    - task: AzureCLI@2
      displayName: "Login & Terraform Init/Plan"
      inputs:
        azureSubscription: $(service_connection)
        scriptType: bash
        addSpnToEnvironment: true       # capture servicePrincipalId if needed
        useGlobalConfig: true
        scriptLocation: inlineScript
        inlineScript: |
          #----------------------------------------------------------------
          # 1) Login context is established by AzureCLI@2
          #----------------------------------------------------------------
          export ARM_USE_AZUREAD=true
          export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
          export ARM_TENANT_ID=$(az account show --query tenantId -o tsv)
          echo "Azure CLI auth ready: sub=$ARM_SUBSCRIPTION_ID tenant=$ARM_TENANT_ID"

          #----------------------------------------------------------------
          # 2) Install Terraform CLI
          #----------------------------------------------------------------
          TERRAFORM_VER=1.5.6
          wget https://releases.hashicorp.com/terraform/${TERRAFORM_VER}/terraform_${TERRAFORM_VER}_linux_amd64.zip
          unzip terraform_${TERRAFORM_VER}_linux_amd64.zip
          sudo mv terraform /usr/local/bin
          terraform version

          #----------------------------------------------------------------
          # 3) terraform init (must include use_azuread_auth here too)
          #----------------------------------------------------------------
          terraform init \
            -backend-config="resource_group_name=$(resource_group)" \
            -backend-config="storage_account_name=tfstatestorageacct2" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=vmss.tfstate" \
            -backend-config="use_azuread_auth=true"

          #----------------------------------------------------------------
          # 4) terraform plan
          #----------------------------------------------------------------
          terraform plan \
            -var="location=$(location)" \
            -var="resource_group=$(resource_group)" \
            -var="vnet_name=$(vnet_name)" \
            -var="subnet_name=$(subnet_name)" \
            -var="vmss_name=$(vmss_name)" \
            -var="vm_size=$(vm_size)" \
            -var="image_sku=$(image_sku)" \
            -var="identity_type=$(identity_type)"

  - job: ConfirmPlan
    displayName: "âœ”ï¸ Approve Plan"
    pool: server                   # agentless
    timeoutInMinutes: 1440
    steps:
      - task: ManualValidation@0
        timeoutInMinutes: 1440
        inputs:
          notifyUsers: ''  
          instructions: |
            Please review the Terraform plan  
            in the â€œInit & Planâ€ job above,  
            then click Approve to continue.
          onTimeout: reject

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Apply Stage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- stage: TerraformApply
  displayName: "ğŸš€ Terraform Apply"
  dependsOn: TerraformPlan
  jobs:
  - job: Apply
    displayName: "Apply"
    pool:
      vmImage: ubuntu-latest
    steps:

    - task: AzureCLI@2
      displayName: "Login & Terraform Apply"
      inputs:
        azureSubscription: $(service_connection)
        scriptType: bash
        addSpnToEnvironment: true
        useGlobalConfig: true
        scriptLocation: inlineScript
        inlineScript: |
          export ARM_USE_AZUREAD=true
          export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
          export ARM_TENANT_ID=$(az account show --query tenantId -o tsv)

          TERRAFORM_VER=1.5.6
          wget https://releases.hashicorp.com/terraform/${TERRAFORM_VER}/terraform_${TERRAFORM_VER}_linux_amd64.zip
          unzip terraform_${TERRAFORM_VER}_linux_amd64.zip
          sudo mv terraform /usr/local/bin

          terraform apply -auto-approve \
            -var="location=$(location)" \
            -var="resource_group=$(resource_group)" \
            -var="vnet_name=$(vnet_name)" \
            -var="subnet_name=$(subnet_name)" \
            -var="vmss_name=$(vmss_name)" \
            -var="vm_size=$(vm_size)" \
            -var="image_sku=$(image_sku)" \
            -var="identity_type=$(identity_type)"
 
 
 