trigger: none

variables:
  service_connection: DevOpsMI-ServiceConnection

stages:

# ────────────────── Terraform Plan Stage ──────────────────
- stage: TerraformPlan
  displayName: "📝 Terraform Plan"
  jobs:
  - job: Plan
    displayName: "Terraform Init & Plan"
    pool:
      name: Default  # Name of your self-hosted agent pool
    steps:

    - checkout: self

    - task: PowerShell@2
      displayName: "Install latest Terraform"
      inputs:
        targetType: 'inline'
        script: |
          Write-Host "🔵 Downloading latest Terraform version"
          $latestVersion = Invoke-RestMethod -Uri "https://checkpoint-api.hashicorp.com/v1/check/terraform" | Select-Object -ExpandProperty current_version
          Write-Host "Latest Terraform version: $latestVersion"
          Invoke-WebRequest -Uri "https://releases.hashicorp.com/terraform/$latestVersion/terraform_${latestVersion}_windows_amd64.zip" -OutFile "terraform.zip"
          Expand-Archive -Path terraform.zip -DestinationPath "$env:USERPROFILE\terraform"
          $env:PATH += ";$env:USERPROFILE\terraform"
          terraform version

    - task: AzureCLI@2
      displayName: "Terraform Init & Plan"
      inputs:
        azureSubscription: $(service_connection)
        scriptType: 'ps'
        addSpnToEnvironment: true
        useGlobalConfig: true
        scriptLocation: 'inlineScript'
        inlineScript: |
          Write-Host "🔵 Exporting environment variables for Terraform authentication"
          $env:ARM_CLIENT_ID = $env:servicePrincipalId
          $env:ARM_CLIENT_SECRET = $env:servicePrincipalKey
          $env:ARM_SUBSCRIPTION_ID = (az account show --query id -o tsv)
          $env:ARM_TENANT_ID = (az account show --query tenantId -o tsv)

          Write-Host "🔵 Terraform Init"
          terraform init -backend-config="resource_group_name=tfstate-rg" `
                         -backend-config="storage_account_name=tfstatestorageacct2" `
                         -backend-config="container_name=tfstate" `
                         -backend-config="key=vmss.tfstate" `
                         -backend-config="subscription_id=$env:ARM_SUBSCRIPTION_ID" `
                         -backend-config="tenant_id=$env:ARM_TENANT_ID"

          Write-Host "🔵 Terraform Plan"
          terraform plan

# ────────────────── Terraform Apply Stage ──────────────────
- stage: TerraformApply
  displayName: "🚀 Terraform Apply"
  dependsOn: TerraformPlan
  jobs:
  - job: Apply
    displayName: "Terraform Apply"
    pool:
      name: Default  # Self-hosted pool
    steps:

    - checkout: self

    - task: PowerShell@2
      displayName: "Install latest Terraform"
      inputs:
        targetType: 'inline'
        script: |
          Write-Host "🔵 Downloading latest Terraform version"
          $latestVersion = Invoke-RestMethod -Uri "https://checkpoint-api.hashicorp.com/v1/check/terraform" | Select-Object -ExpandProperty current_version
          Write-Host "Latest Terraform version: $latestVersion"
          Invoke-WebRequest -Uri "https://releases.hashicorp.com/terraform/$latestVersion/terraform_${latestVersion}_windows_amd64.zip" -OutFile "terraform.zip"
          Expand-Archive -Path terraform.zip -DestinationPath "$env:USERPROFILE\terraform"
          $env:PATH += ";$env:USERPROFILE\terraform"
          terraform version

    - task: AzureCLI@2
      displayName: "Terraform Apply"
      inputs:
        azureSubscription: $(service_connection)
        scriptType: 'ps'
        addSpnToEnvironment: true
        useGlobalConfig: true
        scriptLocation: 'inlineScript'
        inlineScript: |
          Write-Host "🔵 Exporting environment variables for Terraform authentication"
          $env:ARM_CLIENT_ID = $env:servicePrincipalId
          $env:ARM_CLIENT_SECRET = $env:servicePrincipalKey
          $env:ARM_SUBSCRIPTION_ID = (az account show --query id -o tsv)
          $env:ARM_TENANT_ID = (az account show --query tenantId -o tsv)

          Write-Host "🔵 Terraform Apply"
          terraform apply -auto-approve
 