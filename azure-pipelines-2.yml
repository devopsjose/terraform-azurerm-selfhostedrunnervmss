trigger: none

variables:
  service_connection: DevOpsMI-ServiceConnection

stages:

- stage: TerraformPlan
  displayName: "ğŸ“ Terraform Plan"
  jobs:
  - job: Plan
    displayName: "Terraform Init & Plan"
    pool: 
      name: Default  # <-- Your self-hosted agent pool name
    steps:

    - task: AzureCLI@2
      displayName: "Terraform Init & Plan"
      inputs:
        azureSubscription: $(service_connection)
        scriptType: ps
        addSpnToEnvironment: true
        useGlobalConfig: true
        scriptLocation: inlineScript
        workingDirectory: $(System.DefaultWorkingDirectory)
        inlineScript: |
          $ErrorActionPreference = "Stop"

          Write-Output "ğŸ”µ Logging into Azure using Managed Identity"
          az login --identity

          Write-Output "ğŸ”µ Setting ARM environment variables for Terraform AzureRM provider"
          $env:ARM_USE_MSI = "true"
          $env:ARM_SUBSCRIPTION_ID = (az account show --query id -o tsv)
          $env:ARM_TENANT_ID = (az account show --query tenantId -o tsv)

          Write-Output "ğŸ”µ Terraform Version"
          terraform version

          Write-Output "ğŸ”µ Terraform Init (reconfiguring backend)"
          terraform init -reconfigure

          Write-Output "ğŸ”µ Terraform Plan"
          terraform plan

- stage: TerraformApply
  displayName: "ğŸš€ Terraform Apply"
  dependsOn: TerraformPlan
  jobs:
  - job: Apply
    displayName: "Terraform Apply"
    pool: 
      name: Default  # <-- Your self-hosted agent pool name
    steps:

    - task: AzureCLI@2
      displayName: "Terraform Apply"
      inputs:
        azureSubscription: $(service_connection)
        scriptType: ps
        addSpnToEnvironment: true
        useGlobalConfig: true
        scriptLocation: inlineScript
        workingDirectory: $(System.DefaultWorkingDirectory)
        inlineScript: |
          $ErrorActionPreference = "Stop"

          Write-Output "ğŸ”µ Logging into Azure using Managed Identity"
          az login --identity

          Write-Output "ğŸ”µ Setting ARM environment variables for Terraform AzureRM provider"
          $env:ARM_USE_MSI = "true"
          $env:ARM_SUBSCRIPTION_ID = (az account show --query id -o tsv)
          $env:ARM_TENANT_ID = (az account show --query tenantId -o tsv)

          Write-Output "ğŸ”µ Terraform Version"
          terraform version

          Write-Output "ğŸ”µ Terraform Init (reconfiguring backend)"
          terraform init -reconfigure

          Write-Output "ğŸ”µ Terraform Apply"
          terraform apply -auto-approve
 