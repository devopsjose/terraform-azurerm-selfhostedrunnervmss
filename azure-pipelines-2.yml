trigger: none

variables:
  service_connection: DevOpsMI-ServiceConnection

stages:

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Terraform Plan Stage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- stage: TerraformPlan
  displayName: "ğŸ“ Terraform Plan"
  jobs:
  - job: Plan
    displayName: "Terraform Init & Plan"
    pool:
      name: Default  # Your self-hosted agent pool
    steps:

    - checkout: self

    - task: PowerShell@2
      displayName: "Install latest Terraform"
      inputs:
        targetType: 'inline'
        script: |
          Write-Host "ğŸ”µ Installing latest Terraform"
          $latestVersion = Invoke-RestMethod -Uri "https://checkpoint-api.hashicorp.com/v1/check/terraform" | Select-Object -ExpandProperty current_version
          Write-Host "Latest Terraform version: $latestVersion"
          Invoke-WebRequest -Uri "https://releases.hashicorp.com/terraform/$latestVersion/terraform_${latestVersion}_windows_amd64.zip" -OutFile "terraform.zip"
          Expand-Archive -Path terraform.zip -DestinationPath "$env:USERPROFILE\terraform"
          $env:PATH += ";$env:USERPROFILE\terraform"
          terraform version

    - task: AzureCLI@2
      displayName: "Terraform Init & Plan"
      inputs:
        azureSubscription: $(service_connection)
        scriptType: 'ps'
        addSpnToEnvironment: true
        useGlobalConfig: true
        scriptLocation: 'inlineScript'
        inlineScript: |
          Write-Host "ğŸ”µ Authenticating with Managed Identity"

          $env:ARM_USE_MSI = "true"
          $env:ARM_SUBSCRIPTION_ID = (az account show --query id -o tsv)
          $env:ARM_TENANT_ID = (az account show --query tenantId -o tsv)

          Write-Host "ğŸ”µ Running Terraform Init"
          terraform init

          Write-Host "ğŸ”µ Running Terraform Plan"
          terraform plan

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Terraform Apply Stage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- stage: TerraformApply
  displayName: "ğŸš€ Terraform Apply"
  dependsOn: TerraformPlan
  jobs:
  - job: Apply
    displayName: "Terraform Apply"
    pool:
      name: Default
    steps:

    - checkout: self

    - task: AzureCLI@2
      displayName: "Terraform Apply"
      inputs:
        azureSubscription: $(service_connection)
        scriptType: 'ps'
        addSpnToEnvironment: true
        useGlobalConfig: true
        scriptLocation: 'inlineScript'
        inlineScript: |
          Write-Host "ğŸ”µ Authenticating with Managed Identity"

          $env:ARM_USE_MSI = "true"
          $env:ARM_SUBSCRIPTION_ID = (az account show --query id -o tsv)
          $env:ARM_TENANT_ID = (az account show --query tenantId -o tsv)

          Write-Host "ğŸ”µ Running Terraform Apply"
          terraform apply -auto-approve
 