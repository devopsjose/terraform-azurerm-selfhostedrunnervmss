trigger: none

variables:
  service_connection: DevOpsMI-ServiceConnection

stages:

- stage: TerraformPlan
  displayName: "üìù Terraform Plan"
  jobs:
  - job: Plan
    displayName: "Terraform Init & Plan"
    pool:
      vmImage: ubuntu-latest
    steps:

    - task: AzureCLI@2
      displayName: "Terraform Init & Plan"
      inputs:
        azureSubscription: $(service_connection)
        scriptType: bash
        addSpnToEnvironment: true
        useGlobalConfig: true
        scriptLocation: inlineScript
        inlineScript: |
          set -e

          echo "üîµ Installing latest Terraform"
          LATEST_TERRAFORM_VERSION=$(curl -s https://checkpoint-api.hashicorp.com/v1/check/terraform | jq -r .current_version)
          echo "Latest Terraform version: $LATEST_TERRAFORM_VERSION"
          wget https://releases.hashicorp.com/terraform/${LATEST_TERRAFORM_VERSION}/terraform_${LATEST_TERRAFORM_VERSION}_linux_amd64.zip
          unzip terraform_${LATEST_TERRAFORM_VERSION}_linux_amd64.zip
          sudo mv terraform /usr/local/bin
          terraform -version

          echo "üîµ Exporting environment variables for authentication"
          export ARM_USE_MSI=true
          export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
          export ARM_TENANT_ID=$(az account show --query tenantId -o tsv)

          echo "üîµ Terraform Init"
          terraform init

          echo "üîµ Terraform Plan"
          terraform plan

- stage: TerraformApply
  displayName: "üöÄ Terraform Apply"
  dependsOn: TerraformPlan
  jobs:
  - job: Apply
    displayName: "Terraform Apply"
    pool:
      vmImage: ubuntu-latest
    steps:

    - task: AzureCLI@2
      displayName: "Terraform Apply"
      inputs:
        azureSubscription: $(service_connection)
        scriptType: bash
        addSpnToEnvironment: true
        useGlobalConfig: true
        scriptLocation: inlineScript
        inlineScript: |
          set -e

          echo "üîµ Installing latest Terraform"
          LATEST_TERRAFORM_VERSION=$(curl -s https://checkpoint-api.hashicorp.com/v1/check/terraform | jq -r .current_version)
          echo "Latest Terraform version: $LATEST_TERRAFORM_VERSION"
          wget https://releases.hashicorp.com/terraform/${LATEST_TERRAFORM_VERSION}/terraform_${LATEST_TERRAFORM_VERSION}_linux_amd64.zip
          unzip terraform_${LATEST_TERRAFORM_VERSION}_linux_amd64.zip
          sudo mv terraform /usr/local/bin
          terraform -version

          echo "üîµ Exporting environment variables for authentication"
          export ARM_USE_MSI=true
          export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
          export ARM_TENANT_ID=$(az account show --query tenantId -o tsv)

          echo "üîµ Terraform Apply"
          terraform apply -auto-approve
 